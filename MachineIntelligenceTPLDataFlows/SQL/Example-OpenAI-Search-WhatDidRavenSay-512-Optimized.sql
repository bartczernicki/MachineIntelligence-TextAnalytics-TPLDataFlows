-- Clear all cache from SQL memory, this will show performance as a firt-time run
DBCC FREESYSTEMCACHE ('ALL')
DBCC FREEPROCCACHE
DBCC DROPCLEANBUFFERS
SET NOCOUNT ON
SET STATISTICS TIME ON
SET STATISTICS IO ON
go

-- Embeddings - "What Did the Raven Say?"
declare @jsonExample1 nvarchar(max) = N'{
    "object": "list",
    "data": [
        {
            "object": "embedding",
            "index": 0,
            "embedding": [
                0.03811267,
                -0.034216892,
                0.022261592,
                0.0021282495,
                0.039205138,
                0.030362338,
                0.02527103,
                -0.00015548008,
                -0.052355967,
                0.024075499,
                -0.032980137,
                -0.076596364,
                -0.02551838,
                0.02694065,
                -0.0072401706,
                -0.04369868,
                0.0006409226,
                0.014995656,
                -0.024446527,
                0.036463663,
                -0.009698221,
                0.035762835,
                -0.034258116,
                0.02846598,
                -0.0117594795,
                0.032423597,
                0.04427583,
                0.017417634,
                -0.0029759419,
                -0.110401005,
                0.006730009,
                -0.038133282,
                -0.020880548,
                -0.016407618,
                -0.07033014,
                -0.0095539335,
                -0.019087253,
                -0.080636434,
                0.04975878,
                0.034897108,
                0.01896358,
                -0.026445948,
                -0.012295407,
                0.036175087,
                -0.041596197,
                -0.0032335992,
                -0.047779974,
                -0.08962352,
                0.046295866,
                0.021808116,
                -0.08764471,
                0.05684951,
                -0.016376698,
                0.15376988,
                0.034649756,
                0.01990145,
                -0.045471363,
                -0.017025996,
                -0.0057818303,
                -0.056973185,
                0.049222853,
                0.008574835,
                -0.074823685,
                -0.06484719,
                -0.031021941,
                0.009136529,
                0.0068124593,
                0.023869373,
                -0.041183945,
                -0.06674355,
                0.026301658,
                0.059941396,
                -0.05078941,
                -0.056808285,
                0.0046326783,
                0.03772103,
                0.023292221,
                0.04753262,
                0.026033696,
                -0.02401366,
                -0.03485588,
                -0.004490967,
                -0.0021115018,
                -0.048192225,
                -0.0058282083,
                -0.045471363,
                -0.022364656,
                0.011110184,
                0.07041259,
                0.019633487,
                0.027229225,
                0.040957205,
                -0.035597935,
                -0.105041735,
                -0.018891435,
                -0.015974753,
                -0.038380634,
                0.12392286,
                0.018530713,
                0.05087186,
                0.032382373,
                -0.042874176,
                0.02926987,
                0.0016000519,
                0.037123267,
                0.014408197,
                0.02318916,
                0.005812749,
                -0.010064094,
                -0.03755613,
                -0.12821028,
                0.024219787,
                0.068351336,
                -0.051531464,
                -0.011728561,
                -0.0050603896,
                -0.01303746,
                -0.020746566,
                -0.016830176,
                0.0399678,
                -0.01159458,
                -0.003851977,
                0.05087186,
                -0.016366392,
                0.015119331,
                -0.030279888,
                0.07977071,
                0.06880481,
                -0.03396954,
                0.081873186,
                0.00081612956,
                0.008775808,
                0.0074462965,
                -0.076843716,
                0.021189738,
                0.031207453,
                -0.031805217,
                -0.023993049,
                -0.053386595,
                0.056025006,
                0.008394475,
                0.023415897,
                0.003524752,
                -0.06163163,
                -0.02026217,
                0.02121035,
                0.005292281,
                -0.020705342,
                -0.03188767,
                -0.06859868,
                -0.06954686,
                0.037844706,
                -0.017489778,
                0.059364244,
                0.019478893,
                -0.08323362,
                -0.012109893,
                0.06418759,
                -0.07935845,
                0.017912336,
                -0.033948928,
                0.062250007,
                0.012408776,
                -0.0041482826,
                -0.0034088062,
                -0.032031957,
                0.015995366,
                -0.0018796101,
                -0.032155633,
                0.0014055206,
                -0.054499675,
                0.046254642,
                -0.033062585,
                0.010862832,
                0.0020432225,
                0.010800995,
                0.008368709,
                -0.066537425,
                -0.028280467,
                -0.0010815166,
                -0.10429968,
                0.07527716,
                0.05590133,
                0.0053025875,
                0.016448842,
                -0.013171442,
                -0.033413,
                0.029805798,
                0.044440735,
                0.007049504,
                0.031063166,
                0.0971265,
                0.04394603,
                -0.015170863,
                -0.02615737,
                -0.020787792,
                -0.012851947,
                -0.054582126,
                -0.055035602,
                -0.043492556,
                0.07028891,
                0.053056795,
                0.026528398,
                -0.044440735,
                -0.027002487,
                0.048934277,
                -0.06163163,
                -0.00048342953,
                0.008528457,
                -0.037061427,
                0.14164968,
                -0.020303397,
                0.0663313,
                0.06229123,
                -0.07074239,
                0.020385846,
                0.033680964,
                0.06451739,
                -0.00450385,
                0.058457293,
                -0.054252323,
                0.021478314,
                0.01614996,
                0.040709857,
                0.019922063,
                0.07486491,
                0.022096692,
                -0.017768048,
                0.004534769,
                0.024817552,
                0.10644339,
                -0.0011768498,
                -0.05581888,
                -0.056725834,
                -0.019478893,
                0.044440735,
                0.021148512,
                -0.017397022,
                -0.020962998,
                0.06872236,
                0.0022673844,
                -0.04806855,
                0.026837585,
                0.10619604,
                -0.0048980657,
                -0.017077526,
                0.0028651494,
                0.009765212,
                0.058787093,
                -0.0067351623,
                0.047738746,
                -0.008683052,
                0.07750332,
                -0.014222683,
                -0.07144322,
                0.10009471,
                -0.031846445,
                0.044935435,
                0.017613454,
                -0.055241726,
                -0.042832952,
                0.030279888,
                -0.09300398,
                0.01587169,
                -0.018355507,
                -0.01754131,
                0.019911757,
                -0.0540462,
                0.013119911,
                0.0035376349,
                -0.022632618,
                -0.029249258,
                0.051449012,
                0.053922523,
                0.024075499,
                0.047986098,
                0.013697063,
                -0.01256337,
                -0.023951825,
                0.01770621,
                0.011965605,
                0.0070649637,
                0.012728271,
                -0.04169926,
                -0.05351027,
                0.018056624,
                0.0117697865,
                0.044358283,
                0.021354638,
                0.0054829475,
                0.011254472,
                -0.050047357,
                -0.021148512,
                -0.02065381,
                0.0009108186,
                -0.026281046,
                0.08047153,
                0.048893053,
                -0.027373513,
                -0.018396731,
                0.10116657,
                0.022137916,
                0.08348097,
                -0.015005962,
                0.05445845,
                0.11196756,
                0.026693298,
                -0.026033696,
                -0.0071371077,
                -0.0489755,
                0.059281796,
                0.07362816,
                0.0005826276,
                -0.020076659,
                -0.041204557,
                -0.07445266,
                0.007781251,
                -0.00002433654,
                0.13736227,
                -0.011017427,
                0.04592484,
                0.044688083,
                0.032423597,
                0.031145616,
                -0.0096209245,
                -0.05256209,
                0.07758577,
                -0.033928316,
                0.037597355,
                0.026755136,
                -0.041658033,
                -0.0401327,
                -0.03005315,
                0.051531464,
                0.027971279,
                -0.070453815,
                -0.04464686,
                0.020303397,
                -0.022014242,
                0.0025289066,
                0.0025752848,
                0.00920352,
                -0.021066062,
                -0.031928893,
                -0.054334775,
                0.022220368,
                0.017015688,
                0.027002487,
                -0.052603316,
                0.036649175,
                0.026177984,
                0.07086607,
                0.034093216,
                -0.11633743,
                -0.017015688,
                -0.025703894,
                -0.022447105,
                0.009260204,
                0.022570781,
                0.06315696,
                0.012779803,
                0.018273057,
                0.023024257,
                0.03677285,
                -0.011914074,
                0.016180879,
                -0.012573677,
                0.028280467,
                0.02918742,
                -0.014604016,
                -0.030815816,
                0.017829886,
                -0.05256209,
                -0.02021064,
                -0.03085704,
                0.094982795,
                0.015861385,
                0.054252323,
                0.06694967,
                0.032918297,
                0.0035170224,
                0.009445718,
                -0.07519471,
                -0.0014274215,
                0.004310607,
                0.069423184,
                0.0095951585,
                -0.016747726,
                -0.035515483,
                0.036855303,
                -0.0066424054,
                -0.02782699,
                -0.03141358,
                0.0394731,
                -0.053304143,
                -0.04489421,
                0.013841351,
                0.08715001,
                -0.037040815,
                0.06286839,
                0.06377534,
                -0.06760928,
                -0.037205715,
                0.09514769,
                -0.010249608,
                0.09465299,
                0.02054044,
                0.06468229,
                -0.058869544,
                -0.055860106,
                0.0335779,
                0.0069155223,
                0.07589554,
                0.00918806,
                0.0036226618,
                0.016582824,
                0.048893053,
                -0.09704405,
                -0.02774454,
                0.060807128,
                -0.07564819,
                -0.042152736,
                -0.028960682,
                0.011336922,
                0.02176689,
                0.08224422,
                -0.05796259,
                0.008332637,
                0.09292153,
                0.011295697,
                0.06348676,
                0.0042461925,
                0.07284488,
                0.04336888,
                -0.031310517,
                -0.032897685,
                -0.054252323,
                0.056767058,
                -0.006173469,
                0.028486593,
                0.007332927,
                0.0031434193,
                0.0060807127,
                -0.028816395,
                -0.087809615,
                0.01793295,
                0.02448775,
                -0.025003066,
                -0.036566727,
                0.0026950955,
                0.0021720512,
                -0.037597355,
                -0.08393445,
                0.027414737,
                -0.038586758,
                -0.052026164,
                0.03755613,
                0.020200333,
                -0.012140812,
                -0.05198494,
                0.01762376,
                -0.03844247,
                0.010759769,
                0.03811267,
                0.004341526,
                -0.0036741933,
                0.03429934,
                0.026260434,
                0.026260434,
                -0.0674856,
                0.003254212,
                0.035453647,
                0.022612005,
                0.035948347,
                -0.0011394895,
                -0.02790944,
                0.008961322,
                -0.008837646,
                0.01881929,
                -0.0008798997,
                0.0303005,
                -0.036463663,
                -0.008389322,
                -0.046625666,
                -0.077626996,
                -0.054128647,
                -0.022673843,
                -0.0017378986,
                -0.003547941,
                0.012583983,
                0.012243875,
                0.01978808,
                -0.055241726,
                -0.024137337,
                0.043162752,
                0.04679057,
                -0.034814656,
                -0.0601063,
                0.0019298532,
                -0.09885796,
                -0.036175087,
                0.025724506,
                0.089128815,
                0.047738746,
                -0.019798389,
                0.034876496,
                0.04575994,
                -0.03124868,
                0.008750042,
                -0.044935435,
                0.081873186,
                -0.0006950306
            ]
        }
    ],
    "model": "ada",
    "usage": {
        "prompt_tokens": 6,
        "total_tokens": 6
    }
}'

-- select @jsonExample1


drop table if exists #t;
select
    cast([key] as int) as [vector_value_id],
    cast([value] as float) as [vector_value]
into
	#t
from 
    openjson(@jsonExample1, '$.data[0].embedding')

drop table if exists #results;
select top(25)
    v2.Id, 
    sum(v1.[vector_value] * v2.[vector_value]) as dot_product
into
    #results
from 
    #t v1
inner join 
    dbo.ProjectGutenbergBooksVectorsIndex v2 on v1.vector_value_id = v2.vector_value_id
inner join
	dbo.ProjectGutenbergBooks b1 on b1.Id = v2.Id
--where
--	b1.Author = 'Edgar Allen Poe'
group by
    v2.Id
order by
    dot_product desc;

select 
    a.Id,
    a.BookTitle,
	a.Author,
	d.Paragraph,
    d.Url,
    r.dot_product
from 
    #results r
inner join 
    dbo.ProjectGutenbergBooks a on r.Id = a.Id
inner join 
    dbo.ProjectGutenbergBookDetails d on d.Id = r.Id
order by
    dot_product desc;
go